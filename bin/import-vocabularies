#!/usr/bin/env python
"""
Import some basic EarthChem vocabularies from
http://www.earthchem.org/resources/vocabularies
for data categorization.
"""

import pandas as P
from sparrow import App

def get_table(category):
    url = f'http://www.earthchem.org/petdbWeb/search/vocabulary.jsp?category={category}'
    tables = P.read_html(url, index_col=0) # Returns list of all tables on page
    df = tables[0]
    df.index.names = ['id']
    df.rename(columns={
        'METHOD_NAME': 'description',
        'DESCRIPTION': 'description'}, inplace=True)
    return df

app = App(__name__)
conn = app.database.engine

def write_table(tbl, name):
    try:
        return tbl.to_sql(name, conn, schema='earthchem_vocabulary', if_exists='fail')
    except:
        print(f"Table `earthchem_vocabulary.{name}` already exists.")

def copy_table(category, tbl):
    df = get_table(category)
    write_table(df, tbl)
    return df

try:
    conn.execute("CREATE SCHEMA IF NOT EXISTS earthchem_vocabulary")
except:
    print("Schema already exists")

units = copy_table("Unit", "unit")
methods = copy_table("Method", "method")
parameters = copy_table("MeasuredParameter", "parameter")
